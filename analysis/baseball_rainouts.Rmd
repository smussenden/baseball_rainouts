---
title: "Baseball Rainouts"
author: "Sean Mussenden | Howard Center for Investigative Journalism"
date: "10/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries

```{r}
library(tidyverse)  # attaches purrr and readr
library(fs)
library(lubridate)
library(rvest)
library(stringr)
library(downloader)
```

## Scrape zip files from retrosheet

```{r}

# Store the retrosheet link as an object
page <- read_html("https://www.retrosheet.org/schedule/index.html")

# Get a list of all of the links to the ZIP files to download

page <- page %>%
  html_nodes("a") %>%       # find all links
  html_attr("href") %>%     # get the url
  str_subset("\\.ZIP")      # of links that end in .ZIP

# For loop to download each zipfile and unzip it into a folder as a text file. 
for (url in page) {
    # Download each file into download folder, store it as a single zip file called a.zip that will be overwritten. 
    download(url, dest="../data/download/a.zip", mode="wb") 
    # Unzip each file into the unzip folder. 
    unzip ("../data/download/a.zip", exdir = "../data/unzipped")
}
```

```{r}

# Create an object with data directory path
data_dir <- "../data/unzipped"

# Use FS Package to store list of files in my directory as a vector
txt_files <- dir_ls(data_dir)

# Read in all year data
data <- txt_files %>% 
  map_dfr(read_csv, col_names=c(
        "date",
        "game_no",
        "day",
        "visit_team",
        "visit_league",
        "visit_season_game_no",
        "home_team",
        "home_league",
        "home_season_game_no",
        "time_of_day",
        "cancel_postpone_indicate",
        "makeup_date"),
        col_types = cols(
          date = col_double(),
          game_no = col_double(),
          day = col_character(),
          visit_team = col_character(),
          visit_league = col_character(),
          visit_season_game_no = col_double(),
          home_team = col_character(),
          home_league = col_character(),
          home_season_game_no = col_character(),
          time_of_day = col_character(),
          cancel_postpone_indicate = col_character(),
          makeup_date = col_double()
        )
        )

```

## Cleaning

```{r}
glimpse(data)

data_x <- data %>%
  mutate(date = ymd(date), makeup_date = ymd(date)) %>%
  mutate(year = year(date)) %>%
  mutate(month = month(date))

year_check <- data_x %>%
  group_by(year) %>%
  summarise(count=n())

postpone_check <- data_x %>%
  group_by(cancel_postpone_indicate) %>%
  summarise(count=n())

teams <- data_x %>%
  group_by(home_team) %>%
  summarise(count=n()) %>%
  arrange(home_team)

```

### Analysis by Year 
```{r}
# Create a subset of the last 100 years
data_x <- data_x %>%
  filter(year > 1920) %>%
  # Add a line to filter for specific years
  filter(home_team == "BAL")

#STL, ANAHEIM, CARDINALS, METS, PHILLY, DETROIT, DENVER, LAD, BOSTON,RANGERS (TEXAS), CIN, WHITE SOX, KC, SF, SD, PITT, CLEVE


# Create a total_games by year dataframe

total_games_year <- data_x %>%
  group_by(year) %>%
  summarise(count=n()) %>%
  arrange(year) %>%
  filter(!is.na(year))

# Filter data set to create a list of rain postponed games by year

#weather_postponed_games <- data_x %>%
#  filter(str_detect(str_to_lower(cancel_postpone_indicate),"rain|snow|hurricane|inclement|threatening|wet|flood"))
weather_postponed_games <- data_x %>%
  filter(str_detect(str_to_lower(cancel_postpone_indicate),"rain"))

# Data frame of rain postponed games by year

weather_postponed_games_year <- weather_postponed_games %>%
  group_by(year) %>%
  summarise(count=n()) %>%
  arrange(year) %>%
  filter(!is.na(year))

# Join the two dataframes together and calculate percentage

pct_weather_postponed_year <- weather_postponed_games_year %>%
  inner_join(total_games_year, by="year") %>%
  rename(total=count.y, postponed=count.x) %>%
  mutate(pct_postponed = (postponed/total)*100)




view(pct_weather_postponed_year)

```

### Analysis by Month and Year 
```{r}
# Create a subset of the last 100 years
data_x <- data_x %>%
  filter(year > 1920) %>%
  # Add a line to filter for specific years
  filter(home_team == "BAL")

# Create a total_games by year dataframe

total_games_month_year <- data_x %>%
  group_by(month, year) %>%
  summarise(count=n()) %>%
  arrange(year, month) %>%
  filter(!is.na(year))

# Filter data set to create a list of rain postponed games by year

weather_postponed_games <- data_x %>%
  filter(str_detect(str_to_lower(cancel_postpone_indicate),"rain|snow|hurricane|inclement|threatening|wet|flood"))

# Data frame of rain postponed games by year

weather_postponed_games_month_year <- weather_postponed_games %>%
  group_by(month, year) %>%
  summarise(count=n()) %>%
  arrange(year, month) %>%
  filter(!is.na(year))

# Join the two dataframes together and calculate percentage

pct_weather_postponed_month_year <- weather_postponed_games_month_year %>%
  inner_join(total_games_month_year, by=c("year","month")) %>%
  rename(total=count.y, postponed=count.x) %>%
  mutate(pct_postponed = (postponed/total)*100)




view(pct_weather_postponed_month_year)

```